<!-- templates/create_group.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create Group</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      margin: 0;
      padding: 0;
      color: #333;
    }
    .container {
      max-width: 700px;
      margin: 2rem auto;
      background: #fff;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 1.5rem;
      color: #555;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
      color: #555;
    }
    input[type="text"] {
      width: 100%;
      padding: 0.7rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    input[type="text"]:focus {
      border-color: #007bff;
      box-shadow: 0 0 8px rgba(0, 123, 255, 0.2);
      outline: none;
      background-color: #fff;
    }
    .search-container {
      position: relative;
      margin-bottom: 1rem;
    }
    .search-results {
      position: absolute;
      top: 42px; /* just below the input */
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      max-height: 180px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }
    .search-results div {
      padding: 0.5rem;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    .search-results div:last-child {
      border-bottom: none;
    }
    .search-results div:hover {
      background: #f0f0f0;
    }
    .selected-users {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .chip {
      background-color: #007bff;
      color: #fff;
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      display: inline-flex;
      align-items: center;
    }
    .chip span {
      margin-right: 0.4rem;
    }
    .chip button {
      background: none;
      border: none;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
    }
    .buttons {
      text-align: center;
      margin-top: 1.5rem;
    }
    button {
      background-color: #28a745;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 0.6rem 1.2rem;
      margin: 0.5rem;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #218838;
    }
    #cancelBtn {
        background-color: rgb(255, 0, 0);
    }
    #cancelBtn:hover {
        background-color: rgb(200, 0, 0);
    }
    @media (max-width: 600px) {
      .search-container {
        max-width: 100%;
      }
    }
  </style>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
</head>
<body>
<div class="container">
  <h2>Create a New Group</h2>
  
  <!-- Group Name -->
  <label for="groupName">Group Name</label>
  <input type="text" id="groupName" placeholder="Enter group name..." />
  
  <!-- Search Users -->
  <div class="search-container">
    <label for="userSearch">Add Members</label>
    <input
      type="text"
      id="userSearch"
      placeholder="Type a username to search..."
      autocomplete="off"
      aria-label="Search for a user to add to the group"
    />
    <div class="search-results" id="searchResults"></div>
  </div>
  
  <!-- Selected Users -->
  <div class="selected-users" id="selectedUsers"></div>
  
  <div class="buttons">
    <button id="cancelBtn">Cancel</button>
    <button id="createBtn">Create Group</button>
  </div>
</div>

<script>
  // ---------------------- TOKEN, USERNAME, NODE_NAME ----------------------
  let token = {{ token|tojson }};
  let username = {{ username|tojson }};
  let nodeName = {{ node_name|tojson }};

  // ---------------------- SELECTED MEMBERS ----------------------
  let selectedMembers = [];

  // ---------------------- SEARCH BAR LOGIC ----------------------
  const userSearchInput = document.getElementById('userSearch');
  const searchResultsDiv = document.getElementById('searchResults');

  function debounce(func, delay) {
    let debounceTimer;
    return function() {
      const context = this;
      const args = arguments;
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => func.apply(context, args), delay);
    };
  }

  userSearchInput.addEventListener('input', debounce(() => {
    const query = userSearchInput.value.trim();
    if (!query) {
      searchResultsDiv.style.display = 'none';
      searchResultsDiv.innerHTML = '';
      return;
    }

    // Call the Erlangified search function
    erlangifyUserSearch(query)
      .then(data => {
        if (data.error) {
          console.error("Search via Erlang error:", data.error);
          // Optionally display an error or fallback
          searchResultsDiv.innerHTML = "<div style='padding: 0.5rem; color: red;'>Error searching users.</div>";
          searchResultsDiv.style.display = 'block';
          return;
        }

        if (data.users && data.users.length) {
          showSearchResults(data.users, query);
        } else {
          searchResultsDiv.innerHTML = "<div style='padding: 0.5rem; color: #888;'>No users found.</div>";
          searchResultsDiv.style.display = 'block';
        }
      })
      .catch(err => {
        console.error("Search error:", err);
        searchResultsDiv.innerHTML = "<div style='padding: 0.5rem; color: red;'>Error searching users.</div>";
        searchResultsDiv.style.display = 'block';
      });
  }, 300));

  /**
   * Erlangified User Search Function
   * Sends a POST request to /search_users_via_erlang with node_name, token, and query.
   * @param {string} query - The search query string.
   * @returns {Promise} - Resolves with the search results or rejects with an error.
   */
  function erlangifyUserSearch(query) {
    const formData = new FormData();
    formData.append("node_name", nodeName);
    formData.append("token", token);
    formData.append("query", query);

    return fetch("/search_users_via_erlang", {
      method: "POST",
      body: formData
    })
    .then(resp => resp.json());
  }

  function showSearchResults(users, query) {
    searchResultsDiv.innerHTML = "";
    users.forEach(u => {
      if (selectedMembers.includes(u)) return; // Prevent showing already selected users
  
      const div = document.createElement("div");
      const index = u.toLowerCase().indexOf(query.toLowerCase());
      if (index !== -1) {
        const beforeMatch = u.substring(0, index);
        const matchText = u.substring(index, index + query.length);
        const afterMatch = u.substring(index + query.length);
        div.innerHTML = `${beforeMatch}<strong>${matchText}</strong>${afterMatch}`;
      } else {
        div.textContent = u;
      }
      div.addEventListener("click", () => {
        selectUser(u);
        userSearchInput.value = ''; // Clear search input
        searchResultsDiv.style.display = 'none';
        searchResultsDiv.innerHTML = '';
      });
      searchResultsDiv.appendChild(div);
    });
    searchResultsDiv.style.display = 'block';
  }

  // ---------------------- SELECT USER LOGIC ----------------------
  function selectUser(usernameToAdd) {
    if (!selectedMembers.includes(usernameToAdd)) { // Avoid adding duplicates
      selectedMembers.push(usernameToAdd);
      renderSelectedUsers();
    }
  }

  function removeSelectedUser(usernameToRemove) {
    selectedMembers = selectedMembers.filter(u => u !== usernameToRemove);
    renderSelectedUsers();
  }

  function renderSelectedUsers() {
    const container = document.getElementById('selectedUsers');
    container.innerHTML = '';
    selectedMembers.forEach(u => {
      const chip = document.createElement('div');
      chip.classList.add('chip');
      chip.innerHTML = `
        <span>${u}</span>
        <button onclick="removeSelectedUser('${u}')">&times;</button>
      `;
      container.appendChild(chip);
    });
  }

  // ---------------------- CREATE GROUP LOGIC ----------------------
  const createBtn = document.getElementById('createBtn');
  const groupNameInput = document.getElementById('groupName');

  createBtn.addEventListener('click', () => {
    const groupName = groupNameInput.value.trim();
    if (!groupName) {
      alert('Please enter a group name.');
      return;
    }
    if (!selectedMembers.length) {
      alert('Please select at least one member to add to the group.');
      return;
    }

    // Prepare FormData for group creation via Erlang
    const formData = new FormData();
    formData.append("node_name", nodeName);
    formData.append("token", token);
    formData.append("group_name", groupName);
    // Convert members array to a JSON string
    formData.append("members", JSON.stringify(selectedMembers));

    // Send POST request to /create_group_via_erlang
    fetch("/create_group_via_erlang", {
      method: "POST",
      body: formData
    })
    .then(resp => resp.json())
    .then(data => {
      if (data.error) {
        alert('Error creating group: ' + data.error);
      } else if (data.message) {
        alert(data.message);
        // Redirect to the newly created group chat
        window.location.href = `/group_chat/${encodeURIComponent(groupName)}`;
      } else {
        alert('Unexpected response from server.');
      }
    })
    .catch(err => {
      console.error("Create group error:", err);
      alert('An error occurred while creating the group.');
    });
  });

  // ---------------------- CANCEL BUTTON LOGIC ----------------------
  const cancelBtn = document.getElementById('cancelBtn');
  cancelBtn.addEventListener('click', () => {
    window.location.href = '/dashboard';
  });

  // ---------------------- GLOBAL FUNCTIONS FOR ERLANGIFIED CREATE GROUP ----------------------
  /**
   * Extract error messages from Erlang's stdout.
   * Reuses the existing extract_error_from_stdout function from Flask.
   * This should be defined in your Flask app as it's used server-side.
   * If needed client-side, consider defining a similar parser.
   */
  // Since parsing is handled server-side, no need for client-side extraction
</script>
</body>
</html>
